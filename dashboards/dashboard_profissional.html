<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MutanoX API - Professional Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10b981',
                        primaryDark: '#059669',
                        secondary: '#6366f1',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        background: '#0f172a',
                        surface: '#1e293b',
                        surfaceLight: '#334155',
                        textPrimary: '#f8fafc',
                        textSecondary: '#94a3b8',
                        textMuted: '#64748b',
                        border: '#334155'
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * { box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        .cyber-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cyber-card:hover {
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        .neon-text {
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .neon-glow {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .status-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        .terminal {
            background: #0a0a0a;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .terminal::-webkit-scrollbar {
            width: 8px;
        }

        .terminal::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .terminal::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        .terminal::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .log-entry {
            padding: 4px 8px;
            border-left: 2px solid transparent;
            margin: 2px 0;
            transition: all 0.2s;
        }

        .log-entry:hover {
            background: rgba(51, 65, 85, 0.3);
            border-left-color: #10b981;
        }

        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .log-auth { color: #a855f7; }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #6366f1);
            border-radius: 12px 12px 0 0;
        }

        .endpoint-item {
            transition: all 0.2s;
        }

        .endpoint-item:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(4px);
        }

        .endpoint-item.active {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid #10b981;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .input-cyber {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            transition: all 0.3s;
        }

        .input-cyber:focus {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
            outline: none;
        }

        .stat-card-gradient {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(99, 102, 241, 0.1));
        }
    </style>
</head>
<body class="text-textPrimary">
    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="cyber-card p-8 w-full max-w-md border-2 border-primary/30 neon-glow">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-primary/20 mx-auto">
                    <i class="fas fa-shield-halved text-4xl text-primary"></i>
                </div>
                <h1 class="text-4xl font-bold tracking-tight neon-text text-primary mb-2">MUTANOX</h1>
                <p class="text-textSecondary text-sm tracking-widest uppercase">Professional API Dashboard</p>
                <p class="text-textMuted text-xs mt-2">Version 2.0.0</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-textSecondary mb-2 uppercase tracking-wider">Admin API Key</label>
                    <input type="password" id="admin-key-input" class="input-cyber w-full p-4 rounded-lg text-center font-mono text-primary" placeholder="•••••••••••••">
                </div>
                <button onclick="login()" class="btn-primary w-full text-white font-bold py-4 rounded-lg uppercase tracking-widest text-sm">
                    <i class="fas fa-unlock mr-2"></i> Authenticate
                </button>
                <p id="login-error" class="text-danger text-sm text-center hidden font-mono">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Authentication Failed: Invalid API Key
                </p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-content" class="hidden">
        <!-- Header -->
        <header class="cyber-card p-4 mb-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center border border-primary/20">
                            <i class="fas fa-server text-primary"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold tracking-tight">MUTANOX <span class="text-primary neon-text">DASHBOARD</span></h1>
                            <p class="text-textMuted text-xs font-mono">api.mutanox.io // v2.0.0</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-4">
                    <!-- Auto-refresh Toggle -->
                    <div class="flex items-center gap-2 cyber-card px-4 py-2">
                        <span class="text-textMuted text-xs uppercase tracking-wider">Auto-refresh</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                        <span id="refresh-rate" class="text-primary text-xs font-mono">2s</span>
                    </div>

                    <!-- Refresh Button -->
                    <button onclick="forceRefresh()" class="cyber-card px-4 py-2 hover:bg-primary/20 transition-all text-primary">
                        <i class="fas fa-sync-alt" id="refresh-icon"></i>
                    </button>

                    <!-- Logout -->
                    <button onclick="logout()" class="cyber-card px-4 py-2 hover:bg-danger/20 transition-all text-danger">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="metric-card cyber-card p-6 stat-card-gradient">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-textMuted text-xs uppercase tracking-wider mb-1">Total Requests</p>
                        <h2 id="stat-total" class="text-3xl font-bold font-mono">0</h2>
                    </div>
                    <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-primary"></i>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <span class="text-primary"><i class="fas fa-arrow-up"></i> <span id="stat-rate">0</span>/s</span>
                    <span class="text-textMuted">current rate</span>
                </div>
            </div>

            <div class="metric-card cyber-card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-textMuted text-xs uppercase tracking-wider mb-1">Active Keys</p>
                        <h2 id="stat-keys" class="text-3xl font-bold font-mono text-primary">0</h2>
                    </div>
                    <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-key text-primary"></i>
                    </div>
                </div>
                <div class="text-xs text-textMuted">
                    <span class="text-textSecondary">Total:</span> <span id="stat-total-keys">0</span>
                </div>
            </div>

            <div class="metric-card cyber-card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-textMuted text-xs uppercase tracking-wider mb-1">Endpoint Hits</p>
                        <h2 id="stat-endpoints" class="text-3xl font-bold font-mono text-secondary">0</h2>
                    </div>
                    <div class="w-10 h-10 bg-secondary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-bolt text-secondary"></i>
                    </div>
                </div>
                <div class="text-xs text-textMuted">
                    <span class="text-textSecondary">Types:</span> <span id="stat-types">0</span>
                </div>
            </div>

            <div class="metric-card cyber-card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-textMuted text-xs uppercase tracking-wider mb-1">System Uptime</p>
                        <h2 id="stat-uptime" class="text-3xl font-bold font-mono text-warning">0s</h2>
                    </div>
                    <div class="w-10 h-10 bg-warning/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clock text-warning"></i>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <span class="status-pulse w-2 h-2 bg-primary rounded-full"></span>
                    <span class="text-primary">ONLINE</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Endpoint Statistics -->
                <div class="cyber-card">
                    <div class="p-6 border-b border-border">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold flex items-center gap-2">
                                <i class="fas fa-chart-pie text-primary"></i>
                                Endpoint Statistics
                            </h3>
                            <div class="flex gap-2">
                                <select id="chart-type" onchange="updateChartType()" class="bg-surface border border-border rounded-lg px-3 py-1 text-xs">
                                    <option value="doughnut">Doughnut</option>
                                    <option value="bar">Bar</option>
                                    <option value="line">Line</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="chart-container">
                                <canvas id="endpointChart"></canvas>
                            </div>
                            <div id="endpoint-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                                <p class="text-textMuted text-sm text-center py-8">
                                    <i class="fas fa-spinner fa-spin mb-2"></i><br>
                                    Loading endpoint data...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Request Timeline Chart -->
                <div class="cyber-card">
                    <div class="p-6 border-b border-border">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-chart-area text-secondary"></i>
                            Request Timeline
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Quick Actions -->
                <div class="cyber-card">
                    <div class="p-6 border-b border-border">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-rocket text-primary"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <button onclick="openCreateModal()" class="w-full cyber-card p-4 text-left hover:bg-primary/20 transition-all flex items-center gap-3 group">
                            <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center group-hover:bg-primary/20">
                                <i class="fas fa-plus text-primary"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">Generate API Key</p>
                                <p class="text-textMuted text-xs">Create new access credential</p>
                            </div>
                        </button>
                        <button onclick="clearLogs()" class="w-full cyber-card p-4 text-left hover:bg-warning/20 transition-all flex items-center gap-3 group">
                            <div class="w-10 h-10 bg-warning/10 rounded-lg flex items-center justify-center group-hover:bg-warning/20">
                                <i class="fas fa-broom text-warning"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">Clear Logs</p>
                                <p class="text-textMuted text-xs">Clear terminal history</p>
                            </div>
                        </button>
                        <button onclick="exportStats()" class="w-full cyber-card p-4 text-left hover:bg-secondary/20 transition-all flex items-center gap-3 group">
                            <div class="w-10 h-10 bg-secondary/10 rounded-lg flex items-center justify-center group-hover:bg-secondary/20">
                                <i class="fas fa-download text-secondary"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">Export Stats</p>
                                <p class="text-textMuted text-xs">Download statistics report</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- API Keys Management -->
                <div class="cyber-card">
                    <div class="p-6 border-b border-border flex justify-between items-center">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-key text-primary"></i>
                            API Keys
                        </h3>
                        <button onclick="openCreateModal()" class="bg-primary text-black text-xs font-bold px-4 py-2 rounded-lg hover:bg-primaryDark transition-all">
                            <i class="fas fa-plus mr-2"></i>NEW
                        </button>
                    </div>
                    <div class="p-4 max-h-[400px] overflow-y-auto">
                        <div id="keys-list" class="space-y-2">
                            <p class="text-textMuted text-sm text-center py-8">
                                <i class="fas fa-spinner fa-spin mb-2"></i><br>
                                Loading keys...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Terminal Logs -->
                <div class="cyber-card">
                    <div class="p-4 bg-black/50 border-b border-border flex justify-between items-center">
                        <h3 class="text-sm font-bold text-primary font-mono flex items-center gap-2">
                            <span class="status-pulse w-2 h-2 bg-primary rounded-full"></span>
                            SYSTEM LOGS
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="toggleLogFilter('all')" class="log-filter active text-xs px-2 py-1 rounded bg-primary/20 text-primary">ALL</button>
                            <button onclick="toggleLogFilter('success')" class="log-filter text-xs px-2 py-1 rounded hover:bg-primary/10 text-textMuted">SUCCESS</button>
                            <button onclick="toggleLogFilter('error')" class="log-filter text-xs px-2 py-1 rounded hover:bg-primary/10 text-textMuted">ERROR</button>
                        </div>
                    </div>
                    <div id="terminal" class="terminal p-4 h-[300px] overflow-y-auto">
                        <div class="text-textMuted text-center py-8">
                            <i class="fas fa-terminal text-2xl mb-2"></i>
                            <p>Awaiting system logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div id="create-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="cyber-card p-8 w-full max-w-md border-2 border-primary/30">
            <h3 class="text-2xl font-bold mb-6 text-primary flex items-center gap-3">
                <i class="fas fa-key"></i>
                Generate API Key
            </h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-textSecondary mb-2">Owner Name</label>
                    <input type="text" id="new-owner" class="input-cyber w-full p-3 rounded-lg" placeholder="Ex: Developer Team">
                </div>
                <div>
                    <label class="block text-sm font-medium text-textSecondary mb-2">Access Level</label>
                    <select id="new-role" class="input-cyber w-full p-3 rounded-lg">
                        <option value="user">Standard User</option>
                        <option value="admin">System Admin</option>
                    </select>
                </div>
                <div class="flex gap-4 mt-8">
                    <button onclick="createKey()" class="flex-1 btn-primary text-white font-bold py-3 rounded-lg">
                        <i class="fas fa-check mr-2"></i> Generate
                    </button>
                    <button onclick="closeCreateModal()" class="flex-1 cyber-card py-3 rounded-lg hover:bg-surfaceLight">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '';
        let adminKey = localStorage.getItem('mutanox_admin_key') || '';
        let refreshInterval = null;
        let refreshRate = 2000;
        let lastTotalRequests = 0;
        let requestHistory = [];
        let endpointChart = null;
        let timelineChart = null;
        let logFilter = 'all';
        let lastData = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            if (adminKey) {
                showDashboard();
            }
        });

        // Login function
        async function login() {
            const key = document.getElementById('admin-key-input').value;
            if (!key) {
                showError('Please enter an API key');
                return;
            }

            try {
                const response = await fetch(`/api/admin/validate?apikey=${key}`);
                if (response.ok) {
                    adminKey = key;
                    localStorage.setItem('mutanox_admin_key', key);
                    showDashboard();
                } else {
                    showError('Authentication Failed: Invalid API Key');
                }
            } catch (error) {
                showError('Connection Error: ' + error.message);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
        }

        function logout() {
            localStorage.removeItem('mutanox_admin_key');
            adminKey = '';
            clearInterval(refreshInterval);
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
            initCharts();
            startAutoRefresh();
        }

        // Charts initialization
        function initCharts() {
            // Endpoint Chart
            const endpointCtx = document.getElementById('endpointChart').getContext('2d');
            endpointChart = new Chart(endpointCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#10b981', '#6366f1', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#06b6d4', '#f97316'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    cutout: '70%'
                }
            });

            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Auto refresh
        function startAutoRefresh() {
            refreshData();
            refreshInterval = setInterval(refreshData, refreshRate);
        }

        // Toggle auto refresh
        document.getElementById('auto-refresh-toggle').addEventListener('change', function() {
            if (this.checked) {
                refreshInterval = setInterval(refreshData, refreshRate);
            } else {
                clearInterval(refreshInterval);
            }
        });

        // Force refresh
        function forceRefresh() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            refreshData().finally(() => {
                icon.classList.remove('fa-spin');
            });
        }

        // Main refresh function
        async function refreshData() {
            try {
                const response = await fetch(`/api/admin/stats?apikey=${adminKey}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error('Invalid response');
                }

                // Check if data changed
                const newData = JSON.stringify(data);
                if (lastData === newData) {
                    return; // Skip update if no change
                }
                lastData = newData;

                updateStats(data);
                updateKeys(data.keys);
                updateEndpoints(data.endpointHits);
                updateLogs(data);

            } catch (error) {
                console.error('Refresh error:', error);
            }
        }

        // Update stats
        function updateStats(data) {
            const currentTotal = data.totalRequests || 0;
            
            // Calculate rate
            const timeDiff = Date.now() - (data.startTime || Date.now());
            const rate = timeDiff > 0 ? (currentTotal / (timeDiff / 1000)).toFixed(2) : '0';
            
            document.getElementById('stat-total').textContent = currentTotal.toLocaleString();
            document.getElementById('stat-rate').textContent = rate;

            const activeKeys = Object.values(data.keys).filter(k => k.active !== false).length;
            document.getElementById('stat-keys').textContent = activeKeys;
            document.getElementById('stat-total-keys').textContent = Object.keys(data.keys).length;

            const totalHits = Object.values(data.endpointHits).reduce((sum, val) => sum + val, 0);
            document.getElementById('stat-endpoints').textContent = totalHits.toLocaleString();
            document.getElementById('stat-types').textContent = Object.keys(data.endpointHits).length;

            // Update uptime
            const uptimeSeconds = Math.floor((Date.now() - data.startTime) / 1000);
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            const seconds = uptimeSeconds % 60;
            document.getElementById('stat-uptime').textContent = 
                `${hours}h ${minutes}m ${seconds}s`;

            // Update timeline
            updateTimeline(currentTotal);
        }

        // Update timeline chart
        function updateTimeline(totalRequests) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Add to history
            requestHistory.push({ time: timeLabel, requests: totalRequests });
            
            // Keep only last 20 data points
            if (requestHistory.length > 20) {
                requestHistory.shift();
            }

            // Update chart
            timelineChart.data.labels = requestHistory.map(h => h.time);
            timelineChart.data.datasets[0].data = requestHistory.map(h => h.requests);
            timelineChart.update('none');
        }

        // Update keys list
        function updateKeys(keys) {
            const container = document.getElementById('keys-list');
            const keysArray = Object.entries(keys);

            if (keysArray.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-textMuted">
                        <i class="fas fa-key text-3xl mb-2"></i>
                        <p>No API keys found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = keysArray.map(([key, info]) => `
                <div class="endpoint-item cyber-card p-3 rounded-lg ${info.active === false ? 'opacity-50' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-sm truncate">${info.owner}</span>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${
                                    info.role === 'admin' 
                                        ? 'bg-danger/10 text-danger' 
                                        : 'bg-primary/10 text-primary'
                                }">
                                    ${info.role.toUpperCase()}
                                </span>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${
                                    info.active !== false 
                                        ? 'bg-primary/10 text-primary' 
                                        : 'bg-danger/10 text-danger'
                                }">
                                    ${info.active !== false ? 'ACTIVE' : 'REVOKED'}
                                </span>
                            </div>
                            <p class="text-textMuted text-[10px] font-mono truncate">${key}</p>
                            <div class="flex gap-4 mt-1 text-xs text-textMuted">
                                <span><i class="fas fa-chart-simple mr-1"></i>${info.usageCount || 0} uses</span>
                                ${info.lastUsed ? `<span><i class="fas fa-clock mr-1"></i>${new Date(info.lastUsed).toLocaleString('pt-BR')}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 ml-2">
                            <button onclick="toggleKey('${key}')" class="text-textMuted hover:text-warning transition-all" title="Toggle">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="deleteKey('${key}')" class="text-textMuted hover:text-danger transition-all" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update endpoints
        function updateEndpoints(endpointHits) {
            const container = document.getElementById('endpoint-list');
            const labels = Object.keys(endpointHits);
            const values = Object.values(endpointHits);

            if (labels.length === 0) {
                container.innerHTML = `
                    <p class="text-textMuted text-sm text-center py-8">
                        <i class="fas fa-chart-pie text-2xl mb-2"></i><br>
                        No endpoint data yet
                    </p>
                `;
                return;
            }

            // Update chart
            endpointChart.data.labels = labels;
            endpointChart.data.datasets[0].data = values;
            endpointChart.update('none');

            // Update list
            const total = values.reduce((sum, val) => sum + val, 0);
            container.innerHTML = labels.map((label, i) => {
                const percentage = total > 0 ? ((values[i] / total) * 100).toFixed(1) : 0;
                return `
                    <div class="endpoint-item cyber-card p-3 rounded-lg cursor-pointer" onclick="selectEndpoint('${label}')">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-semibold text-textPrimary">${label}</p>
                                <div class="w-full bg-surfaceLight rounded-full h-1.5 mt-1">
                                    <div class="bg-primary h-1.5 rounded-full transition-all" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-primary font-mono">${values[i]}</p>
                                <p class="text-xs text-textMuted">${percentage}%</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select endpoint for details
        function selectEndpoint(endpoint) {
            // Remove active class from all items
            document.querySelectorAll('.endpoint-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            event.target.closest('.endpoint-item').classList.add('active');
            
            // Could show endpoint details modal here
            console.log('Selected endpoint:', endpoint);
        }

        // Update logs
        async function updateLogs(stats) {
            try {
                const response = await fetch(`/api/admin/logs?apikey=${adminKey}`);
                if (!response.ok) return;

                const data = await response.json();
                if (!data.success) return;

                const terminal = document.getElementById('terminal');
                
                if (data.logs.length === 0) {
                    terminal.innerHTML = `
                        <div class="text-textMuted text-center py-8">
                            <i class="fas fa-terminal text-2xl mb-2"></i>
                            <p>No logs available</p>
                        </div>
                    `;
                    return;
                }

                // Filter logs
                const filteredLogs = logFilter === 'all' 
                    ? data.logs 
                    : data.logs.filter(log => log.type.toLowerCase() === logFilter);

                terminal.innerHTML = filteredLogs.map(log => {
                    const logClass = `log-${log.type.toLowerCase()}`;
                    return `
                        <div class="log-entry ${logClass}">
                            <span class="text-textMuted">[${log.timestamp}]</span>
                            <span class="font-semibold">[${log.type}]</span>
                            <span>${log.message}</span>
                            ${log.details ? `<span class="text-textMuted text-xs ml-2">${log.details}</span>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Logs error:', error);
            }
        }

        // Toggle log filter
        function toggleLogFilter(filter) {
            logFilter = filter;
            
            // Update button states
            document.querySelectorAll('.log-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-primary/20', 'text-primary');
                btn.classList.add('hover:bg-primary/10', 'text-textMuted');
            });
            
            event.target.classList.add('active', 'bg-primary/20', 'text-primary');
            event.target.classList.remove('hover:bg-primary/10', 'text-textMuted');
            
            // Refresh logs
            refreshData();
        }

        // Key management functions
        async function createKey() {
            const owner = document.getElementById('new-owner').value;
            const role = document.getElementById('new-role').value;

            if (!owner) {
                alert('Please enter an owner name');
                return;
            }

            try {
                const response = await fetch(`/api/admin/keys?owner=${encodeURIComponent(owner)}&role=${role}&apikey=${adminKey}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(`API Key Generated:\n\n${data.key}\n\nCopy it now!`);
                    closeCreateModal();
                    refreshData();
                } else {
                    alert('Failed to generate key: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleKey(key) {
            try {
                const response = await fetch(`/api/admin/toggle?target=${encodeURIComponent(key)}&apikey=${adminKey}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    refreshData();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteKey(key) {
            if (!confirm('Are you sure you want to delete this API key?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/keys?target=${encodeURIComponent(key)}&apikey=${adminKey}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    refreshData();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Modal functions
        function openCreateModal() {
            document.getElementById('create-modal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
            document.getElementById('new-owner').value = '';
        }

        // Other functions
        function clearLogs() {
            document.getElementById('terminal').innerHTML = `
                <div class="text-textMuted text-center py-8">
                    <i class="fas fa-check-circle text-primary text-2xl mb-2"></i>
                    <p>Logs cleared</p>
                </div>
            `;
        }

        function exportStats() {
            if (!lastData) {
                alert('No data to export');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                stats: lastData
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mutanox-stats-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateChartType() {
            const chartType = document.getElementById('chart-type').value;
            endpointChart.config.type = chartType;
            endpointChart.update();
        }

        // Enter key on login
        document.getElementById('admin-key-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
